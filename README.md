# Laravel Excel Import Project

## Условие задания

В рамках данного тестового задания необходимо реализовать функционал импорта данных из Excel файла (формат `.xlsx`) в Laravel-проект, учитывая
следующие требования:

1. Создать форму для загрузки Excel файла с полями:
    - `id` (integer)
    - `name` (string)
    - `date` (формат даты в Excel — `d.m.Y`)

2. Сохранить данные из файла в базу данных.

3. Выполнить валидацию данных из Excel:
    - Строки с ошибками пропускаются.
    - Все ошибки валидации логируются в текстовый файл `result.txt` в формате:
      ```
      <номер строки> - <ошибка1>, <ошибка2>, ...
      ```
    - Файл с отчетом об ошибках добавлен в репозиторий отдельным коммитом.

4. Импортировать валидные данные в базу.

5. Отслеживать прогресс парсинга в Redis с использованием уникального ключа и счетчика обработанных строк.

6. Использовать любой composer-пакет для парсинга Excel, но реализовать процесс импорта самостоятельно.

7. Реализовать RESTful API контроллер для получения импортированных данных, сгруппированных по полю `date`:
   ```json
   [
     {
       "date": "xxxx-xx-xx",
       "items": [
         { ... },
         { ... }
       ]
     },
     {
       "date": "zzzz-zz-zz",
       "items": [ ... ]
     }
   ]

8. Реализовать передачу события (event) через Laravel Echo при создании записей.

9. Написать тесты для проверки логики.

## Выполненные задачи

- Реализована загрузка и обработка Excel файла через форму.

- Для чтения Excel файлов использован пакет **Spout**.
  Выбор Spout обусловлен его эффективной работой с большими объемами данных, так как он не загружает весь файл в память целиком, а читает его
  потоково. Это критично при обработке потенциально миллионов записей.

  В отличие от более популярных пакетов, например, PhpOffice\PhpSpreadsheet, которые читают весь файл целиком
  в память, Spout позволяет значительно снизить потребление ресурсов и избежать ошибок с переполнением памяти.

  Кроме того, по условию задачи, сам процесс импорта должен быть реализован самостоятельно,
  что не позволяет использовать пакеты с полной автоматизацией импорта.
  Spout предоставляет базовый API для чтения данных, оставляя контроль над процессом импорта
  и валидации в наших руках, что делает его идеальным выбором для данной задачи.

- Валидация данных по следующим правилам:

    - `id` — обязателен, уникален (дубликаты пропускаются).

    - `name` — необязателен, строка.

    - `date` — необязателен, формат `d.m.Y`, некорректные даты логируются как ошибки.

- Ошибки валидации собираются и записываются в файл `storage/app/private/result.txt`.

- Данные импортируются в базу асинхронно через очередь.

- Прогресс импорта хранится в Redis по уникальному ключу, обновляется по мере обработки строк.

- Реализован API контроллер для получения импортированных данных с группировкой по `date`.
  Формат запроса "/api/imported-items?date=1994-04-11" 
  (так как загрузка 60к а тем более 6млн записей в 1 json не представляется хорошим решением)
  так же разбиваем на страницы для удобного вывода на гипотетическом фронте.

- Использован Laravel Echo (Reverb) для трансляции событий о создании импортированных записей.

- Покрыта тестами загрузка, валидация, импорт и broadcasting.

---

## Структура проекта и компоненты

- DTO `ImportRowDto` — для удобной работы и валидации строк из Excel.

- Джобы `ImportStartJob` и `ImportChunkJob` — для обработки импорта по частям и фоновой обработки.

- Сервис `ImportService` — логика импорта и валидации.

- API контроллер `ImportedItemsController` — возврат данных с группировкой.

- Redis — хранение прогресса.

- Логирование ошибок в файл с защитой от параллельных записей.

- Тесты на PHPUnit с использованием fake-очередей и fake-хранилищ.
